*** Important ***  
If you are upgrading from sidechain-1, you need to keep all data in the .shuttler directory intact. This directory contains old dkg data, which is very important. Please do not lose or overwrite it.

# TSSigner

The *`TSS`*(**Threshold Signature Scheme**) network is a key building block intended to perform Bitcoin signing in the distributed manner to facilitate the Bitcoin bridge on the [Bitway](https://github.com/bitwaylabs/bitway)

The TSS signature network consists of twenty-one nodes which are a subset of the Bitway validators of well-known reputation.

TSS nodes are mainly responsible for several tasks: *`DKG`*(**Distributed Key Generation**), `Signing` and `Relaying`.

## DKG

The DKG procedure is as follows:

1. Initiate: The DKG initiation is proposed as a governance proposal on the Bitway. The proposal contains the DKG participant set and required  threshold for later signing.

2. Vote: Community members and validators can vote for the proposal.

3. Create: The DKG request is formally created on the Bitway when the proposal passed.

4. Complete: TSS nodes will coordinate to complete the DKG request. All participants listed in the proposal must be connected to the TSS network in the phase.

5. Re-DKG: This happen when some nodes want to quit the TSS network according to their operation demands. New signing keys will be generated by the steps above and all assets held by the previous keys will be transferred to the newly generated ones.

## Signing

Signing is the regular task for TSS nodes.

1. Signing requests are fetched from the Bitway by the TSS node periodically.

2. Sign the requests and broadcast the related messages when signing requests are received.

## Relaying

As the security guard, TSS nodes can contribute to the security of the bitcoin bridge by relaying the bitcoin block headers.

At the same time, the bridge related transactions including deposit and withdrawal can be relayed to the Bitway by TSS nodes as well.

## Get started

### Build shuttler

1. Install *Rust*

```sh
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

2. Check Cargo Version

```sh
cargo version
```

Make sure the cargo version is 1.89.0 or later.  
You can upgrade the cargo version using the following command:

```sh
rustup self update
rustup update stable
```

3. Clone and build shuttler

```sh
git clone https://github.com/bitwaylabs/shuttler.git
cd shuttler
git checkout v2.0.0
cargo build --release
```

4. The binary can be placed into the bin directory of Cargo for convenience.

```sh
cp target/release/shuttler ~/.cargo/bin
```

## Upgrading from sidechain-1

If you are upgrading from sidechain-1, please follow the steps below:

1. Reuse the old data directory  

   By default, it is "~/.shuttler".  
   This directory contains old dkg data, which is very important. Please do not lose or overwrite it.  
   To be on the safe side, back up the original directory before performing the operation.

   ```sh
   cp -r ~/.shuttler ~/.shttler_backup
   ```

2. Generate a new configuration file

   ```sh
   target/release/shuttler --home ~/.shuttler_new init
   ```

   > Note that the file path generated above is different from the old path.

3. Copy the new configuration file

   Backup your old configuration file.

   ```sh
   mv ~/.shuttler/config.toml ~/.shuttler/config_old.toml
   ```

   Copy the new configuration file.

   ```sh
   cp ~/.shuttler_new/config.toml ~/.shuttler/config.toml
   ```

4. Set up the new config file to reuse the old validator key

   ```sh
   vi ~/.shuttler/config.toml
   ```

   Modify the following content:

   ```sh
   priv_validator_key_path = "/home/linuxuser/.bitway/config/priv_validator_key.json"
   ```

   And make sure Bitway uses the sidechain's old validator key.

5. Set up the bootstrapping nodes

   ```sh
   vi ~/.shuttler/config.toml
   bootstrap_nodes = ["<peer address>",...,"<peer address>"]
   ```

   The bootstrapping nodes are used to help connect to the TSS network when started.
   The format of the peer address is like this:

   ```sh
   /ip4/<IP>/tcp/<PORT>/p2p/<PEER ID>
   ```

   Your `peer id` can be retrieved as the following command:

   ```sh
   shuttler address
   ```

   > Please share your node address in the private channel so others can add you. and make sure to add at least 3 bootstrap nodes in your Shuttler config.  
   > The seed node provided by Bitway Labs is as following:

   ```sh
   /ip4/202.182.119.24/tcp/5158/p2p/12D3KooWJsCsfBUcm9yZvqbbCZ2eg8vY6Wgw2qxsafzfHNuSRhzB
   ```

6. Enable the rpc service.

   ```sh
   enable_rpc = true
   rpc_address = "127.0.0.1:6780"
   ```

   Enable the rpc service, then you can visit the metrics as follow:

   ```sh
   curl http://127.0.0.1:6780/metrics
   ```

7. Set the Bitcoin RPC

   ```sh
   [bitcoin]
   network = "bitcoin"
   rpc = "http://192.248.180.245:8332"
   user = "bitway"
   password = "12345678"
   ```

   > You can replace it with your own bitcoin information.

8. Set the Bitway RPC

   ```sh
   [bitway]
   grpc = "http://localhost:9090"
   rpc = "http://localhost:26657"
   gas = 1000000
   ```

   > If you run own Bitway node on the same server, Keep the above configuration.

9. Set the Bitway fee

   ```sh
   [bitway.fee]
   amount = 1000
   denom = "ubtw"
   ```

1. Modify the last scanned height.

   ```sh
   last_scanned_height_bitway = 3226000
   last_scanned_height_bitcoin = 912840
   ```

1. Start shuttler

   ```sh
   target/release/shuttler start --bridge --lending
   ```

1. Submit relayer address to Bitway Labs

   ```sh
   target/release/shuttler address
   ```

   > Get the relayer address as above, and send it to us in TG group.
   > We will add this address to the list of gas payments.

## Start a new shuttler

If you are upgrading from sidechain, please refer to the upgrade instructions above.  
The following instructions are for starting a new shuttle program.

1. Initialize

   ```sh
   target/release/shuttler init
   ```

   > The *home* directory can be replaced by your choice.  
   > You can specify the port by `--port`. The default port is `5158`.

2. Set up the bootstrapping nodes

   ```sh
   vi ~/.shuttler/config.toml
   bootstrap_nodes = ["<peer address>",...,"<peer address>"]
   ```

   The bootstrapping nodes are used to help connect to the TSS network when started.
   The format of the peer address is like this:

   ```sh
   /ip4/<IP>/tcp/<PORT>/p2p/<PEER ID>
   ```

   Your `peer id` can be retrieved as the following command:

   ```sh
   shuttler address
   ```

   > Please share your node address in the private channel so others can add you. and make sure to add at least 3 bootstrap nodes in your Shuttler config.  
   > The seed node provided by Bitway Labs is as following:

   ```sh
   /ip4/202.182.119.24/tcp/5158/p2p/12D3KooWJsCsfBUcm9yZvqbbCZ2eg8vY6Wgw2qxsafzfHNuSRhzB
   ```

3. Enable the rpc service.

   ```sh
   enable_rpc = true
   rpc_address = "127.0.0.1:6780"
   ```

   Enable the rpc service, then you can visit the metrics as follow:

   ```sh
   curl http://127.0.0.1:6780/metrics
   ```

4. Set the Bitcoin RPC

   ```sh
   [bitcoin]
   network = "bitcoin"
   rpc = "http://192.248.180.245:8332"
   user = "bitway"
   password = "12345678"
   ```

   > You can replace it with your own bitcoin information.

5. Set the Bitway RPC

   ```sh
   [bitway]
   grpc = "http://localhost:9090"
   rpc = "http://localhost:26657"
   gas = 1000000
   ```

   > If you run own Bitway node on the same server, Keep the above configuration.

6. Set the Bitway fee

   ```sh
   [bitway.fee]
   amount = 1000
   denom = "ubtw"
   ```

7. Modify the last scanned height.

   ```sh
   last_scanned_height_bitway = 3226000
   last_scanned_height_bitcoin = 912840
   ```

8. Start shuttler

   ```sh
   target/release/shuttler start --bridge --lending
   ```

9. Submit relayer address to Bitway Labs

   ```sh
   target/release/shuttler address
   ```

   > Get the relayer address as above, and send it to us in TG group.
   > We will add this address to the list of gas payments.
  
# Hardware Specifications

## Running only the TSS node

1. Minimum Requirements

   - CPU: 4 cores

   - RAM: 8 GB

   - Storage: 100 GB

   - Network: 1 Gbps

2. Recommended Specifications

   - CPU: 8 cores

   - RAM: 16 GB

   - Storage: 500 GB

   - Network: 1 Gbps

## Running only the Bitcoin full node

1. Minimum Requirements

   - CPU: 4 cores

   - RAM: 8 GB

   - Storage: 200 GB

   - Network: 1 Gbps

2. Recommended Specifications

   - CPU: 8 cores

   - RAM: 16 GB

   - Storage: 500 GB

   - Network: 1 Gbps

## Running both the TSS node and Bitcoin full node

1. Minimum Requirements

   - CPU: 4 cores

   - RAM: 8 GB

   - Storage: 200 GB

   - Network: 1 Gbps

2. Recommended Specifications

   - CPU: 8 cores

   - RAM: 16 GB

   - Storage: 500 GB

   - Network: 1 Gbps

**Note**: To ensure service quality, we strongly recommend not running the validator node on any of the machines listed above.
